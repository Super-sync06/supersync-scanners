<!DOCTYPE html>
<html>
<head>
<title>SuperSync IP Speaker Scanner</title>
<style>
body { font-family: Arial; padding: 20px; }
.device {
    margin:10px 0;
    padding:10px;
    border:1px solid #ccc;
    border-radius: 6px;
}
input {
    padding: 8px;
    width: 240px;
    font-size: 16px;
}
button {
    padding: 10px 20px;
    margin-top: 10px;
    font-size: 16px;
}
</style>
</head>

<body>

<h2>üîç SuperSync IP Speaker Scanner</h2>

<p>Enter your network (example: <b>192.168.25.0</b>)</p>

<input id="ipRange" placeholder="192.168.25.0">
<button onclick="scan()">Scan Network</button>

<div id="result"></div>

<script>
async function scan() {

    console.log("SCAN STARTED");

    let result = document.getElementById("result");
    result.innerHTML = "<p>Scanning...</p>";

    let input = document.getElementById("ipRange").value.trim();

    if (!input.match(/^([0-9]{1,3}\.){3}0$/)) {
        alert("Invalid format! Use 192.168.25.0");
        return;
    }

    let subnet = input.substring(0, input.lastIndexOf(".") + 1);
    const PREFIX = "02:D3:AF";

    for (let i = 1; i <= 254; i++) {

        let ip = subnet + i;
        console.log("Checking:", ip);

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 400);

        try {
            let response = await fetch(`http://${ip}/statusjson`, {
                signal: controller.signal,
                mode: "cors"
            });

            clearTimeout(timeout);

            console.log("Response from", ip, response);

            let text = await response.text();
            console.log("Text:", text);

            let data = {};
            try { data = JSON.parse(text); } catch(e) {
                console.log("JSON parse error at", ip);
            }

            if (data.mac && data.mac.toUpperCase().startsWith(PREFIX)) {
                console.log("FOUND SUPERSYNC DEVICE at", ip);
                result.innerHTML += `
                    <div class="device">
                        <b>SuperSync Speaker Found!</b><br>
                        IP: ${ip}<br>
                        MAC: ${data.mac}<br>
                        Model: ${data.model || "Unknown"}<br>
                        <a href="http://${ip}" target="_blank">Open Device</a>
                    </div>
                `;
            }

        } catch (err) {
            console.log("Error querying", ip, err);
            clearTimeout(timeout);
        }
    }

    result.innerHTML += "<p>Scan complete.</p>";
    console.log("SCAN FINISHED");
}
</script>

</body>
</html>
